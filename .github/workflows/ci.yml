name: Flyway + Test CI + Map Viewer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgis/postgis:16-3.5
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: dpg_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d dpg_dev"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout repositório
        uses: actions/checkout@v4

      - name: Instala Flyway
        run: |
          curl -sL https://download.red-gate.com/maven/release/com/redgate/flyway/flyway-commandline/10.22.0/flyway-commandline-10.22.0-linux-x64.tar.gz \
            | tar xz
          sudo ln -s "$PWD/flyway-10.22.0/flyway" /usr/local/bin/flyway
          flyway -v

      - name: Aplicar baseline e migrações
        env:
          FLYWAY_URL: jdbc:postgresql://localhost:5432/dpg_dev
          FLYWAY_USER: postgres
          FLYWAY_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          FLYWAY_SCHEMAS: geometry_bases
          FLYWAY_CLEAN_DISABLED: "true"
        run: |
          flyway -locations=filesystem:./sql/baseline,filesystem:./sql/migrations migrate
          flyway info

      - name: Rodar TODOS os testes SQL e salvar saída
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          set -euo pipefail
          mkdir -p tests_output
          docker run --rm --network host \
            -e PGPASSWORD="${PGPASSWORD}" \
            -v "${{ github.workspace }}/tests:/tests:ro" \
            -v "${{ github.workspace }}/tests_output:/tests_output" \
            postgres:16 sh -lc '
              set -euo pipefail
              apt-get update >/dev/null 2>&1 || true
              apt-get install -y jq >/dev/null 2>&1 || true
              for f in /tests/*.sql; do
                [ -e "$f" ] || continue
                base="$(basename "$f" .sql)"
                echo "==> Executando $base.sql"
                # Executa o SQL e normaliza a saída:
                #  - remove linhas que são apenas "+" (ou espaços +)
                #  - remove espaços finais
                #  - faz parse + regrava JSON via jq (garante JSON válido)
                psql -q -t -A -v ON_ERROR_STOP=1 -P pager=off -P footer=off \
                     -h localhost -p 5432 -U postgres -d dpg_dev \
                     -f "$f" \
                | sed -e "s/[[:space:]]\+$//" -e "/^[[:space:]]*+[[:space:]]*$/d" \
                | jq -c . > "/tests_output/${base}_result.json"
              done
              echo "Arquivos gerados em /tests_output:"
              ls -lah /tests_output
            '
      - name: Upload dos artefatos de testes (.json)
        uses: actions/upload-artifact@v4
        with:
          name: sql-test-results
          path: tests_output/**/*.json
          if-no-files-found: error

      # ---------- Publish Viewer (sem heredoc) ----------
      - name: Preparar viewer (copiar JSONs e gerar manifest)
        if: ${{ hashFiles('tests_output/*.json') != '' }}
        run: |
          set -euo pipefail
          mkdir -p viewer

          # copia resultados gerados pelos testes
          cp tests_output/*.json viewer/ 2>/dev/null || true

          # lista apenas .json válidos (exclui manifest.json)
          mapfile -t files < <(find viewer -maxdepth 1 -type f -name '*.json' ! -name 'manifest.json' -printf '%f\n' || true)

          # debug no log
          echo "Arquivos para o viewer:" "${files[@]:-<nenhum>}"

          # se não houver json, não gera manifest e deixa o próximo step pular
          if [ "${#files[@]}" -eq 0 ]; then
            echo "Nenhum JSON copiado para viewer/. Verifique o step de testes."
            exit 0
          fi

          # gera manifest.json com os nomes dos arquivos
          printf '%s\n' "${files[@]}" | jq -R . | jq -s . > viewer/manifest.json

          # usa o template HTML
          cp .github/viewer_template.html viewer/index.html

      - name: Publicar viewer no GitHub Pages
        if: ${{ hashFiles('viewer/*.json') != '' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./viewer
