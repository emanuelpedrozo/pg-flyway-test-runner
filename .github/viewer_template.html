<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DPG — GeoJSON Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map{height:100%;margin:0}
    .topbar{position:absolute;left:8px;top:8px;z-index:1000;background:#111;color:#fff;padding:6px 10px;border-radius:6px;font:14px/1.2 system-ui}
    .topbar select{margin-left:6px}
    .layer-controls{position:absolute;top:50px;left:8px;z-index:1000;background:#fff;padding:6px 10px;border-radius:6px;box-shadow:0 0 4px rgba(0,0,0,0.2);font:13px system-ui}
    .layer-controls label{display:block;margin:3px 0}
    button.reset-btn{margin-top:6px;background:#444;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer}
    button.reset-btn:hover{background:#666}
  </style>
</head>
<body>
  <div class="topbar">
    <strong>DPG — GeoJSON Viewer</strong>
    <label> Arquivo:
      <select id="fileSel"></select>
    </label>
  </div>

  <div class="layer-controls" id="layerControls">
    <button class="reset-btn" id="resetBtn">Resetar</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-14.2350, -51.9253], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const sel = document.getElementById('fileSel');
    const layerGroup = L.layerGroup().addTo(map);
    const layerControls = document.getElementById('layerControls');
    const resetBtn = document.getElementById('resetBtn');
    let activeLayers = [];

    async function loadManifest() {
      const files = await fetch('manifest.json').then(r => r.json());
      sel.innerHTML = '';
      for (const f of files) {
        const opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        sel.appendChild(opt);
      }
      if (files.length) loadFile(files[0]);
    }

    async function loadFile(name) {
      console.log('Carregando:', name);
      const res = await fetch(name);
      const text = await res.text();
      const clean = text.replace(/^\s*\+\s?/mg, '').trim();
      const data = JSON.parse(clean);

      layerGroup.clearLayers();
      activeLayers = [];

      const gj = L.geoJSON(data, {
        style: f => (f.properties?.rules?.style) || {},
        pointToLayer: (f, latlng) => {
          const p = f.properties || {};
          const r = (p.rules && p.rules.style) || {};
          return L.circleMarker(latlng, {
            radius: r.radius || 6,
            fillColor: r.fillColor || p.fillColor || '#3388ff',
            color: r.color || p.color || '#3388ff',
            weight: r.weight || 2,
            opacity: r.opacity || 1,
            fillOpacity: r.fillOpacity || 0.6
          });
        },
        onEachFeature: (feature, layer) => {
          // Monta popup DOM
          const container = document.createElement('div');

          const title = document.createElement('div');
          title.style.fontWeight = '600';
          title.style.marginBottom = '6px';
          title.textContent = (feature.properties?.tipo) || (feature.properties?.layerCode) || 'Feature';
          container.appendChild(title);

          const pre = document.createElement('pre');
          pre.style.maxHeight = '260px';
          pre.style.overflow = 'auto';
          pre.style.margin = 0;
          pre.textContent = JSON.stringify(feature.properties || {}, null, 2);
          container.appendChild(pre);

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = 'Excluir esta feature';
          btn.style.marginTop = '8px';
          btn.style.background = '#dc3545';
          btn.style.color = '#fff';
          btn.style.border = 'none';
          btn.style.padding = '6px 10px';
          btn.style.borderRadius = '4px';
          btn.style.cursor = 'pointer';
          btn.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();
            layer.remove();
          });
          container.appendChild(btn);

          layer.bindPopup(container);
        }
      }).addTo(layerGroup);

      activeLayers.push(gj);

      // Gera lista de camadas únicas
      const tipos = [...new Set(data.features.map(f => f.properties?.tipo).filter(Boolean))];
      layerControls.querySelectorAll('label').forEach(l => l.remove());
      tipos.forEach(tipo => {
        const lbl = document.createElement('label');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = true;
        chk.value = tipo;
        chk.addEventListener('change', () => toggleLayer(tipo, chk.checked));
        lbl.appendChild(chk);
        lbl.append(' ' + tipo);
        layerControls.insertBefore(lbl, resetBtn);
      });

      if (gj.getLayers().length) map.fitBounds(gj.getBounds(), { maxZoom: 15 });
    }

    function toggleLayer(tipo, visible) {
      activeLayers.forEach(gj => {
        gj.eachLayer(layer => {
          const props = layer.feature?.properties;
          if (props?.tipo === tipo) {
            if (visible) layer.addTo(layerGroup);
            else layerGroup.removeLayer(layer);
          }
        });
      });
    }

    sel.addEventListener('change', e => loadFile(e.target.value));
    resetBtn.addEventListener('click', () => {
      layerControls.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = true);
      layerGroup.clearLayers();
      loadFile(sel.value);
    });

    loadManifest();
  </script>
</body>
</html>